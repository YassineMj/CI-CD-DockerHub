# ğŸ”¹ DÃ©finition du dÃ©clencheur de la pipeline
trigger:
  branches:
    include:
      - main   # La pipeline sâ€™exÃ©cute automatiquement seulement sur la branche "main"

# ğŸ”¹ DÃ©finition de lâ€™agent qui exÃ©cutera la pipeline
pool:
  name: my-self-hosted-pool   # On utilise un agent self-hosted (installÃ© sur ta machine locale)

# ğŸ”¹ DÃ©claration des variables rÃ©utilisables dans la pipeline
variables:
  imageName: yassine580/my-app-ci   # Nom du repo DockerHub oÃ¹ les images seront pushÃ©es

# ğŸ”¹ DÃ©but des Ã©tapes de la pipeline (stages)
stages:
  # =======================================================
  # 1ï¸âƒ£ Ã‰tape de Build
  - stage: Build
    displayName: "Build Docker Image"   # Nom lisible de lâ€™Ã©tape
    jobs:
      - job: DockerBuild
        steps:
          # Ã‰tape 0 : RÃ©cupÃ©ration du code source depuis Azure DevOps
          - checkout: self

          # Ã‰tape 1 : Build de lâ€™image Docker
          - task: Docker@2
            displayName: "Build Docker image"
            inputs:
              command: build                 # On demande un "docker build"
              dockerfile: 'dockerfile'  # Chemin vers ton Dockerfile
              repository: $(imageName)       # Nom de l'image Docker
              # Liste des tags associÃ©s
              # Un tag unique basÃ© sur lâ€™ID du build (ex: 23)
              # Le tag "latest" (version stable)
              tags: |
                $(Build.BuildId)
                latest

          # Ã‰tape 2 : VÃ©rification rapide que lâ€™image fonctionne
          - script: |
              docker run --rm $(imageName):$(Build.BuildId) echo "Build OK"
            displayName: "Run quick check inside container"
            # On lance le conteneur et affiche "Build OK".
            # Si Ã§a marche, Ã§a veut dire que lâ€™image est exÃ©cutable.

  # =======================================================
  # 2ï¸âƒ£ Ã‰tape de Push (envoi sur DockerHub)
  - stage: Push
    displayName: "Push Docker Image"
    dependsOn: Build   # Cette Ã©tape ne sâ€™exÃ©cute quâ€™aprÃ¨s un build rÃ©ussi
    jobs:
      - job: DockerPush
        steps:
          # Ã‰tape 3 : Connexion Ã  DockerHub via un service connection
          - task: Docker@2
            displayName: 'Login DockerHub'
            inputs:
              command: login
              containerRegistry: 'dockerHubConnection'
              # âš ï¸ "dockerHubConnection" doit Ãªtre crÃ©Ã© dans Azure DevOps
              # avec tes identifiants DockerHub

          # Ã‰tape 4 : Push de lâ€™image vers DockerHub
          - task: Docker@2
            displayName: 'Push Docker image'
            inputs:
              command: push
              repository: $(imageName)
              tags: |
                $(Build.BuildId)
                latest
              # On envoie les 2 tags vers DockerHub
              # Exemple : yassine580/my-app-ci:23 et yassine580/my-app-ci:latest
